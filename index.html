<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chatlog Enhancer</title>
	<link rel="icon"
		href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
	<script>
		// Anti-flicker: Set theme before body renders
		(function () {
			const savedTheme = localStorage.getItem('chatlog_theme') || 'dark';
			document.documentElement.setAttribute('data-theme', savedTheme);
		})();
	</script>
	<style>
		:root {
			/* Light Theme */
			--bg-color: #f4f4f9;
			--sidebar-bg: #ffffff;
			--text-color: #333333;
			--border-color: #e0e0e0;
			--input-bg: #ffffff;
			--output-bg: #ffffff;
			--accent-color: #6c5ce7;
			--accent-hover: #5b4cc4;
			--scroll-thumb: #ccc;

			/* Log Colors (Light) */
			--color-radio: #0984e3;
			--color-ooc: #b2bec3;
			--color-action: #a29bfe;
			--color-env: #636e72;
			--color-phone: #fdcb6e;
			--color-shout: #d63031;
			--color-whisper: #e17055;
			/* Gold-ish orange */
			--color-speech: #2d3436;
			--color-system: #00b894;
			--color-inner-action: #a29bfe;
		}

		[data-theme="dark"] {
			/* Dark Theme */
			--bg-color: #1e1e2e;
			--sidebar-bg: #252537;
			--text-color: #dcdcdc;
			--border-color: #3a3a4e;
			--input-bg: #2b2b3d;
			--output-bg: #181825;
			--accent-color: #7c73e6;
			--accent-hover: #6b63d5;
			--scroll-thumb: #4a4a5e;

			/* Log Colors (Dark) */
			--color-radio: #74b9ff;
			--color-ooc: #636e72;
			/* Dimmer gray */
			--color-action: #cfa0e9;
			/* Light purple */
			--color-env: #a4b0be;
			--color-phone: #ffeaa7;
			--color-shout: #ff7675;
			--color-whisper: #fab1a0;
			--color-speech: #ffffff;
			--color-system: #55efc4;
			--color-inner-action: #cfa0e9;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		body {
			background-color: var(--bg-color);
			color: var(--text-color);
			height: 100vh;
			display: flex;
			overflow: hidden;
			transition: background-color 0.3s, color 0.3s;
			padding-right: 20px;
		}

		/* Sidebar */
		.sidebar {
			width: 350px;
			background-color: var(--sidebar-bg);
			border-right: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			padding: 20px;
			overflow-y: auto;
			flex-shrink: 0;
		}

		.logo {
			font-size: 1.5rem;
			font-weight: bold;
			margin-bottom: 20px;
			color: var(--accent-color);
			display: flex;
			align-items: center;
			gap: 10px;
			cursor: pointer;
			user-select: none;
		}

		.control-group {
			margin-bottom: 20px;
		}

		.control-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			font-size: 0.9rem;
		}

		select,
		button {
			width: 100%;
			padding: 10px;
			border-radius: 6px;
			border: 1px solid var(--border-color);
			background-color: var(--bg-color);
			color: var(--text-color);
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.2s;
		}

		button {
			background-color: var(--accent-color);
			color: white;
			border: none;
			font-weight: 600;
			margin-bottom: 10px;
		}

		button:hover {
			background-color: var(--accent-hover);
		}

		button.secondary {
			background-color: transparent;
			border: 1px solid var(--accent-color);
			color: var(--accent-color);
		}

		button.secondary:hover {
			background-color: var(--accent-color);
			color: white;
		}

		.checkbox-group {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.checkbox-item {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 0.9rem;
			cursor: pointer;
		}

		.checkbox-item input {
			accent-color: var(--accent-color);
			width: 16px;
			height: 16px;
		}

		/* Main Content */
		.main-content {
			flex: 1;
			display: flex;
			flex-direction: row;
			height: 100%;
		}

		.panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			padding: 20px 0 20px 20px;
			min-width: 0;
			/* Fix flex child overflow */
		}

		.panel-header {
			margin-bottom: 10px;
			font-weight: 600;
			display: flex;
			justify-content: space-between;
			align-items: center;
			min-height: 34px;
		}

		.header-actions {
			display: flex;
			gap: 10px;
		}

		.header-actions button {
			width: auto;
			padding: 5px 15px;
			margin: 0;
		}

		textarea {
			flex: 1;
			resize: none;
			background-color: var(--input-bg);
			color: var(--text-color);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			padding: 15px;
			font-family: 'Consolas', 'Monaco', monospace;
			font-size: 0.9rem;
			outline: none;
		}

		textarea:focus {
			border-color: var(--accent-color);
		}

		#output-log {
			flex: 1;
			background-color: var(--output-bg);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			padding: 15px;
			overflow-y: auto;
			font-family: 'Segoe UI', sans-serif;
			line-height: 1.5;
			white-space: pre-wrap;
		}

		/* Scrollbar */
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		::-webkit-scrollbar-track {
			background: transparent;
		}

		::-webkit-scrollbar-thumb {
			background: var(--scroll-thumb);
			border-radius: 4px;
		}

		/* Log Categories */
		.log-line {
			margin-bottom: 2px;
			word-wrap: break-word;
		}

		.log-radio {
			color: var(--color-radio);
		}

		.log-ooc {
			color: var(--color-ooc);
		}

		.log-action {
			color: var(--color-action);
		}

		.log-env {
			color: var(--color-env);
		}

		.log-phone {
			color: var(--color-phone);
		}

		.log-shout {
			color: var(--color-shout);
			font-weight: bold;
		}

		.log-whisper {
			color: var(--color-whisper);
			font-style: italic;
		}

		.log-speech {
			color: var(--color-speech);
		}

		.log-system {
			color: var(--color-system);
		}

		.log-call911 {
			color: #e74c3c;
			font-weight: bold;
		}

		.inner-action {
			color: var(--color-inner-action);
			font-style: italic;
		}

		.timestamp {
			color: #888;
			font-size: 0.85em;
			margin-right: 8px;
			user-select: none;
		}

		.line-count {
			font-size: 0.8rem;
			color: #888;
			margin-left: 10px;
			font-weight: normal;
		}

		.file-name {
			font-size: 0.8rem;
			color: #666;
			margin-top: 5px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		/* Nickname Filter */
		.nickname-filter-input {
			display: flex;
			gap: 8px;
			margin-bottom: 10px;
		}

		.nickname-filter-input input {
			flex: 1;
			padding: 8px;
			border-radius: 6px;
			border: 1px solid var(--border-color);
			background-color: var(--input-bg);
			color: var(--text-color);
			font-size: 0.9rem;
			outline: none;
		}

		.nickname-filter-input input:focus {
			border-color: var(--accent-color);
		}

		.nickname-filter-input button {
			width: auto;
			padding: 8px 16px;
			margin: 0;
		}

		.nickname-list {
			display: flex;
			flex-direction: column;
			gap: 6px;
			margin-bottom: 10px;
			max-height: 200px;
			overflow-y: auto;
		}

		.nickname-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 6px 10px;
			background-color: var(--bg-color);
			border: 1px solid var(--border-color);
			border-radius: 4px;
			font-size: 0.85rem;
		}

		.nickname-item span {
			flex: 1;
			color: var(--text-color);
		}

		.nickname-item button {
			width: 24px;
			height: 24px;
			padding: 0;
			margin: 0;
			border-radius: 4px;
			background-color: transparent;
			border: none;
			color: var(--text-color);
			font-size: 1rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
		}

		.nickname-item button:hover {
			background-color: var(--accent-color);
			color: white;
		}

		.nickname-empty {
			text-align: center;
			padding: 10px;
			color: #888;
			font-size: 0.85rem;
			font-style: italic;
		}

		/* Responsive */
		@media (max-width: 768px) {
			body {
				flex-direction: column;
				overflow: auto;
			}

			.sidebar {
				width: 100%;
				height: auto;
				border-right: none;
				border-bottom: 1px solid var(--border-color);
			}

			.main-content {
				flex-direction: column;
				height: auto;
			}

			.panel {
				height: 500px;
			}
		}
	</style>
</head>

<body>

	<aside class="sidebar">
		<div class="logo">
			<span>üí¨ Chatlog Enhancer</span>
		</div>

		<div class="control-group">
			<label data-i18n="language">Language</label>
			<select id="language-select">
				<option value="en">English</option>
				<option value="ru">–†—É—Å—Å–∫–∏–π</option>
				<option value="ua">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
			</select>
		</div>

		<div class="control-group">
			<label data-i18n="theme">Theme</label>
			<button id="theme-toggle" class="secondary" data-i18n="toggleTheme">Switch Theme</button>
		</div>

		<div class="control-group">
			<label data-i18n="actions">Actions</label>
			<input type="file" id="file-upload" accept=".txt" style="display: none;">
			<button id="upload-btn" data-i18n="uploadFile">Upload File</button>
			<div id="file-name" class="file-name"></div>
		</div>

		<div class="control-group">
			<label data-i18n="nicknameFilter">Nickname Filter</label>
			<div class="nickname-filter-input">
				<input type="text" id="nickname-input" placeholder="Enter nickname...">
				<button id="add-nickname-btn" data-i18n="addNickname">Add</button>
			</div>
			<div id="nickname-list" class="nickname-list">
				<div class="nickname-empty" data-i18n="noNicknames">No nicknames added</div>
			</div>
			<button id="clear-nicknames-btn" class="secondary" data-i18n="clearAllNicknames">Clear
				All</button>
		</div>

		<div class="control-group">
			<label data-i18n="filters">Filters</label>
			<div class="checkbox-group">
				<label class="checkbox-item">
					<input type="checkbox" id="show-timestamps"> <span
						data-i18n="showTimestamps">Show Timestamps</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-ic"> <span data-i18n="filterIC">IC
						Speech</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-action"> <span
						data-i18n="filterAction">Actions (/me, /do)</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-radio"> <span data-i18n="filterRadio">Radio /
						Dep</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-ooc"> <span data-i18n="filterOOC">OOC / PM /
						Admin</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-system"> <span data-i18n="filterSystem">System
						Messages</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-phone"> <span
						data-i18n="filterPhone">Phone</span>
				</label>
				<label class="checkbox-item">
					<input type="checkbox" id="filter-911"> <span data-i18n="filter911">911
						Calls</span>
				</label>
			</div>
		</div>
	</aside>

	<main class="main-content">
		<div class="panel">
			<div class="panel-header">
				<div>
					<span data-i18n="input">Input</span>
					<span id="input-count" class="line-count">0 lines</span>
				</div>
			</div>
			<textarea id="input-log"
				placeholder="Paste your chatlog here or drag & drop a file..."></textarea>
		</div>
		<div class="panel">
			<div class="panel-header">
				<div>
					<span data-i18n="output">Output</span>
					<span id="output-count" class="line-count">0 lines</span>
				</div>
				<div class="header-actions">
					<button id="download-btn" class="secondary"
						data-i18n="download">Download</button>
					<button id="gdocs-btn" class="secondary" data-i18n="openGDocs">Google
						Docs</button>
					<button id="copy-btn" class="secondary" data-i18n="copyText">Copy Text</button>
				</div>
			</div>
			<div id="output-log"></div>
		</div>
	</main>

	<script>
		// --- Translations ---
		const translations = {
			en: {
				language: "Language",
				theme: "Theme",
				toggleTheme: "Switch Theme",
				actions: "Actions",
				uploadFile: "Upload File",
				process: "Process",
				nicknameFilter: "Nickname Filter",
				nicknameInput: "Enter nickname...",
				addNickname: "Add",
				clearAllNicknames: "Clear All",
				noNicknames: "No nicknames added",
				filters: "Filters",
				showTimestamps: "Show Timestamps",
				filterIC: "IC Speech (Say, Shout, Whisper)",
				filterAction: "Actions (/me, /do)",
				filterRadio: "Radio / Dep",
				filterOOC: "OOC / PM / Admin",
				filterSystem: "System Messages",
				filterPhone: "Phone Calls",
				filter911: "911 Calls",
				removeEmpty: "Remove Empty/Junk",
				smartMerge: "Smart Merge Lines",
				input: "Input Log",
				output: "Preview",
				copyText: "Copy Text",
				copied: "Copied!",
				download: "Download .txt",
				openGDocs: "Open Google Docs",
				placeholder: "Paste your chatlog here or drag & drop a file...",
				clearConfirm: "Clear chatlog?",
				lines: "lines"
			},
			ru: {
				language: "–Ø–∑—ã–∫",
				theme: "–¢–µ–º–∞",
				toggleTheme: "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É",
				actions: "–î–µ–π—Å—Ç–≤–∏—è",
				uploadFile: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª",
				process: "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å",
				nicknameFilter: "–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∏–∫–∞–º",
				nicknameInput: "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫...",
				addNickname: "–î–æ–±–∞–≤–∏—Ç—å",
				clearAllNicknames: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë",
				noNicknames: "–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∫–æ–≤",
				filters: "–§–∏–ª—å—Ç—Ä—ã",
				showTimestamps: "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è",
				filterIC: "IC –ß–∞—Ç (–†–µ—á—å, –ö—Ä–∏–∫, –®–µ–ø–æ—Ç)",
				filterAction: "–û—Ç—ã–≥—Ä–æ–≤–∫–∏ (/me, /do)",
				filterRadio: "–†–∞—Ü–∏—è / –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
				filterOOC: "OOC / PM / –ê–¥–º–∏–Ω-—á–∞—Ç",
				filterSystem: "–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
				filterPhone: "–¢–µ–ª–µ—Ñ–æ–Ω",
				filter911: "–í—ã–∑–æ–≤—ã 911",
				removeEmpty: "–£–¥–∞–ª—è—Ç—å –º—É—Å–æ—Ä",
				smartMerge: "–û–±—ä–µ–¥–∏–Ω—è—Ç—å —Å—Ç—Ä–æ–∫–∏",
				input: "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
				output: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
				copyText: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç",
				copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
				download: "–°–∫–∞—á–∞—Ç—å .txt",
				openGDocs: "–û—Ç–∫—Ä—ã—Ç—å Google Docs",
				placeholder: "–í—Å—Ç–∞–≤—å—Ç–µ –ª–æ–≥ —Å—é–¥–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª...",
				clearConfirm: "–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç–ª–æ–≥?",
				lines: "—Å—Ç—Ä–æ–∫"
			},
			ua: {
				language: "–ú–æ–≤–∞",
				theme: "–¢–µ–º–∞",
				toggleTheme: "–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É",
				actions: "–î—ñ—ó",
				uploadFile: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª",
				process: "–û–±—Ä–æ–±–∏—Ç–∏",
				nicknameFilter: "–§—ñ–ª—å—Ç—Ä –∑–∞ –Ω—ñ–∫–∞–º–∏",
				nicknameInput: "–í–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫...",
				addNickname: "–î–æ–¥–∞—Ç–∏",
				clearAllNicknames: "–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ",
				noNicknames: "–ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –Ω—ñ–∫—ñ–≤",
				filters: "–§—ñ–ª—å—Ç—Ä–∏",
				showTimestamps: "–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —á–∞—Å",
				filterIC: "IC –ß–∞—Ç (–ú–æ–≤–∞, –ö—Ä–∏–∫, –®–µ–ø—ñ—Ç)",
				filterAction: "–í—ñ–¥—ñ–≥—Ä–∞–≤–∞–Ω–Ω—è (/me, /do)",
				filterRadio: "–†–∞—Ü—ñ—è / –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç",
				filterOOC: "OOC / PM / –ê–¥–º—ñ–Ω-—á–∞—Ç",
				filterSystem: "–°–∏—Å—Ç–µ–º–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
				filterPhone: "–¢–µ–ª–µ—Ñ–æ–Ω",
				filter911: "–í–∏–∫–ª–∏–∫–∏ 911",
				removeEmpty: "–í–∏–¥–∞–ª—è—Ç–∏ —Å–º—ñ—Ç—Ç—è",
				smartMerge: "–û–±'—î–¥–Ω—É–≤–∞—Ç–∏ —Ä—è–¥–∫–∏",
				input: "–í—Ö—ñ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç",
				output: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
				copyText: "–ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç",
				copied: "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!",
				download: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ .txt",
				openGDocs: "–í—ñ–¥–∫—Ä–∏—Ç–∏ Google Docs",
				placeholder: "–í—Å—Ç–∞–≤—Ç–µ –ª–æ–≥ —Å—é–¥–∏ –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª...",
				clearConfirm: "–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç–ª–æ–≥?",
				lines: "—Ä—è–¥–∫—ñ–≤"
			}
		};

		// --- State & Config ---
		let currentLang = localStorage.getItem('chatlog_lang') || 'en';
		let currentTheme = localStorage.getItem('chatlog_theme') || 'dark';
		let nicknameFilter = JSON.parse(localStorage.getItem('nickname_filter') || '[]');

		// --- Elements ---
		const els = {
			langSelect: document.getElementById('language-select'),
			themeBtn: document.getElementById('theme-toggle'),
			uploadBtn: document.getElementById('upload-btn'),
			fileInput: document.getElementById('file-upload'),
			inputLog: document.getElementById('input-log'),
			outputLog: document.getElementById('output-log'),
			copyBtn: document.getElementById('copy-btn'),
			downloadBtn: document.getElementById('download-btn'),
			gdocsBtn: document.getElementById('gdocs-btn'),
			logo: document.querySelector('.logo'),
			fileName: document.getElementById('file-name'),
			inputCount: document.getElementById('input-count'),
			outputCount: document.getElementById('output-count'),
			filters: {
				timestamps: document.getElementById('show-timestamps'),
				ic: document.getElementById('filter-ic'),
				action: document.getElementById('filter-action'),
				radio: document.getElementById('filter-radio'),
				ooc: document.getElementById('filter-ooc'),
				system: document.getElementById('filter-system'),
				phone: document.getElementById('filter-phone'),
				call911: document.getElementById('filter-911')
			},
			nicknameInput: document.getElementById('nickname-input'),
			addNicknameBtn: document.getElementById('add-nickname-btn'),
			clearNicknamesBtn: document.getElementById('clear-nicknames-btn'),
			nicknameList: document.getElementById('nickname-list')
		};

		// --- Initialization ---
		function init() {
			// Load saved settings
			els.langSelect.value = currentLang;
			updateLanguage(currentLang);
			// Theme is already set by head script, but we sync state here

			// Load saved filters
			Object.keys(els.filters).forEach(key => {
				const savedState = localStorage.getItem('filter_' + key);
				if (savedState !== null) {
					els.filters[key].checked = (savedState === 'true');
				}
			});

			// Load saved log
			const savedLog = localStorage.getItem('saved_input_log');

			if (savedLog) {
				els.inputLog.value = savedLog;
				// We'll process it below
			}

			// Event Listeners
			els.langSelect.addEventListener('change', (e) => updateLanguage(e.target.value));
			els.themeBtn.addEventListener('click', toggleTheme);
			els.uploadBtn.addEventListener('click', () => els.fileInput.click());
			els.fileInput.addEventListener('change', handleFileUpload);

			els.inputLog.addEventListener('input', () => {
				localStorage.setItem('saved_input_log', els.inputLog.value);
				processLogs();
			});

			els.copyBtn.addEventListener('click', copyToClipboard);
			els.downloadBtn.addEventListener('click', downloadLog);
			els.gdocsBtn.addEventListener('click', openGoogleDocs);

			els.logo.addEventListener('click', () => {
				if (confirm(translations[currentLang].clearConfirm || "Clear chatlog?")) {
					els.inputLog.value = '';
					els.fileName.textContent = '';
					localStorage.removeItem('saved_input_log');
					processLogs();
				}
			});

			// Auto-process on filter change & save state
			Object.entries(els.filters).forEach(([key, cb]) => {
				cb.addEventListener('change', () => {
					localStorage.setItem('filter_' + key, cb.checked);
					processLogs();
				});
			});

			// Nickname filter event listeners
			els.addNicknameBtn.addEventListener('click', addNickname);
			els.nicknameInput.addEventListener('keypress', (e) => {
				if (e.key === 'Enter') addNickname();
			});
			els.clearNicknamesBtn.addEventListener('click', clearNicknames);

			// Render initial nickname list
			renderNicknameList();

			// Drag & Drop
			els.inputLog.addEventListener('dragover', (e) => { e.preventDefault(); els.inputLog.style.borderColor = 'var(--accent-color)'; });
			els.inputLog.addEventListener('dragleave', () => { els.inputLog.style.borderColor = 'var(--border-color)'; });
			els.inputLog.addEventListener('drop', handleDrop);

			// Initial process if we loaded data
			if (savedLog) processLogs();
		}

		// --- Nickname Filter Functions ---
		function renderNicknameList() {
			if (nicknameFilter.length === 0) {
				els.nicknameList.innerHTML = `<div class="nickname-empty" data-i18n="noNicknames">${translations[currentLang].noNicknames || 'No nicknames added'}</div>`;
			} else {
				els.nicknameList.innerHTML = nicknameFilter.map(nick => `
					<div class="nickname-item">
						<span>${nick}</span>
						<button onclick="removeNickname('${nick.replace(/'/g, "\\'")}')">‚úï</button>
					</div>
				`).join('');
			}
		}

		function addNickname() {
			const nickname = els.nicknameInput.value.trim();
			if (!nickname) return;

			// Check if already exists (case-insensitive)
			if (nicknameFilter.some(n => n.toLowerCase() === nickname.toLowerCase())) {
				els.nicknameInput.value = '';
				return;
			}

			nicknameFilter.push(nickname);
			localStorage.setItem('nickname_filter', JSON.stringify(nicknameFilter));
			els.nicknameInput.value = '';
			renderNicknameList();
			processLogs();
		}

		function removeNickname(nickname) {
			nicknameFilter = nicknameFilter.filter(n => n !== nickname);
			localStorage.setItem('nickname_filter', JSON.stringify(nicknameFilter));
			renderNicknameList();
			processLogs();
		}

		function clearNicknames() {
			nicknameFilter = [];
			localStorage.setItem('nickname_filter', JSON.stringify(nicknameFilter));
			renderNicknameList();
			processLogs();
		}

		// Extract nickname from log line
		function extractNickname(text) {
			// Pattern 1: Name Surname says/–≥–æ–≤–æ—Ä–∏—Ç/–∫–∞–∂–µ
			let match = text.match(/^(?:\[!\]\s*)?([A-Z][a-z]+\s+[A-Z][a-z]+)\s+(?:says|–≥–æ–≤–æ—Ä–∏—Ç|–∫–∞–∂–µ)/i);
			if (match) return match[1];

			// Pattern 2: Name Surname shouts/–∫—Ä–∏—á–∏—Ç
			match = text.match(/^([A-Z][a-z]+\s+[A-Z][a-z]+)\s+(?:shouts|–∫—Ä–∏—á–∏—Ç)/i);
			if (match) return match[1];

			// Pattern 3: Name Surname whispers/—à–µ–ø—á–µ—Ç
			match = text.match(/^([A-Z][a-z]+\s+[A-Z][a-z]+)\s+(?:whispers|—à–µ–ø—á–µ—Ç)/i);
			if (match) return match[1];

			// Pattern 4: * Name Surname or > Name Surname (actions)
			match = text.match(/^[*>]\s*([A-Z][a-z]+\s+[A-Z][a-z]+)/);
			if (match) return match[1];

			return null;
		}


		// --- Core Logic: Parsing ---
		function processLogs() {
			const rawText = els.inputLog.value;

			// Update input count
			const inputLines = rawText ? rawText.split(/\r?\n/).length : 0;
			els.inputCount.textContent = `${inputLines} ${translations[currentLang].lines}`;

			// If empty, clear output
			if (!rawText) {
				els.outputLog.innerHTML = '';
				els.outputCount.textContent = `0 ${translations[currentLang].lines}`;
				return;
			}

			const lines = rawText.split(/\r?\n/);
			let processedLines = [];

			// 1. Pre-processing (Cleaning & Merging)
			let bufferLine = null;

			for (let i = 0; i < lines.length; i++) {
				let line = lines[i].trim();

				// Skip empty lines if filter is on
				// HARDCODED: removeEmpty is always true
				if (!line) continue;
				if (line === '---' || line.match(/^_+$/)) continue;

				// Timestamp extraction
				let timestamp = "";
				const timeMatch = line.match(/^\[(\d{2}:\d{2}:\d{2})\]\s*/);
				if (timeMatch) {
					timestamp = timeMatch[1];
					line = line.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '');
				}

				// Smart Merge Logic
				// HARDCODED: smartMerge is always true
				// If smart merge is ON, and this line has NO timestamp, and it's not a system message start (heuristic),
				// append to previous line.
				if (!timeMatch && bufferLine && line.length > 0) {
					bufferLine.content += " " + line;
				} else {
					if (bufferLine) processedLines.push(bufferLine);
					bufferLine = { timestamp, content: line, original: lines[i] };
				}
			}
			if (bufferLine) processedLines.push(bufferLine);

			// 2. Categorization & Rendering
			els.outputLog.innerHTML = '';

			processedLines.forEach(item => {
				const { type, formattedContent } = categorizeAndFormat(item.content);

				// Check filters
				if (type === 'radio' && !els.filters.radio.checked) return;
				if (type === 'ooc' && !els.filters.ooc.checked) return;
				if (type === 'action' && !els.filters.action.checked) return;
				if (type === 'env' && !els.filters.action.checked) return; // Grouped with action
				if (type === 'phone' && !els.filters.phone.checked) return;
				if (type === 'call911' && !els.filters.call911.checked) return;
				if (type === 'system' && !els.filters.system.checked) return;
				if ((type === 'speech' || type === 'shout' || type === 'whisper') && !els.filters.ic.checked) return;

				// Nickname filter - only filter speeches and actions
				if (nicknameFilter.length > 0) {
					const isSpeechType = ['speech', 'shout', 'whisper'].includes(type);
					const isActionType = ['action', 'env'].includes(type);

					if (isSpeechType || isActionType) {
						const nickname = extractNickname(item.content);
						// If nickname doesn't match any in the filter list, skip this line
						if (!nickname || !nicknameFilter.some(n => n.toLowerCase() === nickname.toLowerCase())) {
							return;
						}
					}
				}

				// Build HTML
				const div = document.createElement('div');
				div.className = `log-line log-${type}`;

				if (els.filters.timestamps.checked && item.timestamp) {
					const tsSpan = document.createElement('span');
					tsSpan.className = 'timestamp';
					tsSpan.textContent = `[${item.timestamp}]`;
					div.appendChild(tsSpan);
					// Add explicit space after timestamp for copy/download
					div.appendChild(document.createTextNode(" "));
				}

				div.innerHTML += formattedContent; // Safe because we sanitize in categorizeAndFormat if needed, but here we want inner HTML for styling
				els.outputLog.appendChild(div);
			});

			// Update output count (based on actually visible lines)
			els.outputCount.textContent = `${els.outputLog.childElementCount} ${translations[currentLang].lines}`;
		}

		function categorizeAndFormat(text) {
			// Helper to escape HTML but allow our specific tags later
			const escape = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

			// We escape first, then apply formatting to the escaped string
			let safeText = escape(text);
			let type = 'system';

			// Regex Patterns (Priority Order)

			// 1. Radio / Dep: **[S: or ** [ or (–†–∞—Ü–∏—è)
			if (/^\*\*(\s*)\[/.test(text) || /^\(–†–∞—Ü–∏—è\)/.test(text)) {
				type = 'radio';
			}
			// 1.5. 911 Calls
			else if (/\*{10,}\s+(–≠–ö–°–¢–†–ï–ù–ù–´–ô –í–´–ó–û–í|EMERGENCY CALL)\s+\*{10,}/.test(text) ||
				/^\*\s+(–ù–æ–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞|–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞|–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ|–°–∏—Ç—É–∞—Ü–∏—è|Call Number|Phone Number|Location|Situation):/.test(text)) {
				type = 'call911';
			}
			// 2. OOC / PM / Admin: ((, [Adm, or double brackets
			else if (/^\(\(/.test(text) || /^\[Adm/.test(text) || /\(\(.*\)\)/.test(text)) {
				// Note: (( text )) is often OOC, but sometimes part of /do. 
				// Strict OOC line start:
				if (/^\(\(/.test(text) || /^\[Adm/.test(text)) {
					type = 'ooc';
				} else {
					// Check if it's purely OOC line wrapped in (( ))
					if (/^\(\(.*\)\)$/.test(text)) type = 'ooc';
				}
			}

			// 3. Action (/me): * Name Surname OR > Name Surname
			if (/^(\*|>)\s*[A-Z][a-z]+\s+[A-Z][a-z]+/.test(text) && !text.includes('((')) {
				type = 'action';
			}

			// 4. Environment (/do): Starts with * ... (( Name Surname )) OR just * text
			// /do often ends with (( Name Surname ))
			else if (/^\*/.test(text) && (text.includes('((') || text.endsWith('))'))) {
				type = 'env';
			}

			// 5. Phone: (cellphone): or (phone):
			else if (/\(cellphone\):/i.test(text) || /\(phone\):/i.test(text) || /\(—Ç–µ–ª–µ—Ñ–æ–Ω\):/i.test(text)) {
				type = 'phone';
			}

			// 6. Shout: shouts: or –∫—Ä–∏—á–∏—Ç:
			else if (/shouts:\s*$/i.test(text) || /–∫—Ä–∏—á–∏—Ç:\s*$/i.test(text) || /shouts:/i.test(text) || /–∫—Ä–∏—á–∏—Ç:/i.test(text)) {
				type = 'shout';
			}

			// 7. Whisper: whispers: or —à–µ–ø—á–µ—Ç:
			else if (/whispers:\s*$/i.test(text) || /—à–µ–ø—á–µ—Ç:\s*$/i.test(text) || /whispers:/i.test(text) || /—à–µ–ø—á–µ—Ç:/i.test(text)) {
				type = 'whisper';
			}

			// 8. IC Speech: Name Surname says: or Name Surname –≥–æ–≤–æ—Ä–∏—Ç:
			// Also handles: Name Surname says (to ...):
			// Also handles: [!] Name Surname says: (Low speech/Foreign)
			else if (/^(\[!\]\s*)?[A-Z][a-z]+\s+[A-Z][a-z]+\s+(says|–≥–æ–≤–æ—Ä–∏—Ç|–∫–∞–∂–µ)/i.test(text)) {
				type = 'speech';
			}

			// Fallback for OOC if it contains (( )) but wasn't caught by strict start
			if (type === 'system' && text.includes('((') && text.includes('))')) {
				// Could be inline OOC or /do, but if we are here, it didn't match /do pattern strictly
				// Let's leave it as system or check for OOC color
				if (/^\(\(/.test(text)) type = 'ooc';
			}

			// --- Inner Formatting ---
			// Highlight text between * * for IC speech types
			if (['speech', 'shout', 'whisper'].includes(type)) {
				// Regex to find *text* and wrap in span
				// We need to be careful with already escaped text. * becomes *
				safeText = safeText.replace(/\*([^*]+)\*/g, '<span class="inner-action">*$1*</span>');
			}

			return { type, formattedContent: safeText };
		}

		// --- UI Helpers ---
		function updateLanguage(lang) {
			currentLang = lang;
			localStorage.setItem('chatlog_lang', lang);
			document.querySelectorAll('[data-i18n]').forEach(el => {
				const key = el.getAttribute('data-i18n');
				if (translations[lang][key]) {
					if (el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
						// Handle placeholder separately if needed, but here we just update textContent for labels
					}
					if (el.placeholder) {
						el.placeholder = translations[lang].placeholder;
					}
					if (el.childNodes.length === 1 && el.childNodes[0].nodeType === 3) {
						el.textContent = translations[lang][key];
					} else if (el.tagName === 'SPAN') {
						el.textContent = translations[lang][key];
					} else if (el.tagName === 'BUTTON') {
						el.textContent = translations[lang][key];
					}
				}
			});
			// Update placeholder explicitly
			els.inputLog.placeholder = translations[lang].placeholder;
			els.nicknameInput.placeholder = translations[lang].nicknameInput;

			// Re-process logs to update counters with new language
			processLogs();
		}

		function toggleTheme() {
			const newTheme = currentTheme === 'light' ? 'dark' : 'light';
			setTheme(newTheme);
		}

		function setTheme(theme) {
			currentTheme = theme;
			localStorage.setItem('chatlog_theme', theme);
			document.documentElement.setAttribute('data-theme', theme);
		}

		function handleFileUpload(e) {
			const file = e.target.files[0];
			if (!file) return;
			els.fileName.textContent = file.name;
			readFile(file);
		}

		function handleDrop(e) {
			e.preventDefault();
			els.inputLog.style.borderColor = 'var(--border-color)';
			const file = e.dataTransfer.files[0];
			if (file) readFile(file);
		}

		function readFile(file) {
			const reader = new FileReader();
			reader.onload = (e) => {
				els.inputLog.value = e.target.result;
				processLogs();
			};
			reader.readAsText(file);
		}

		function copyToClipboard() {
			const text = els.outputLog.innerText; // innerText gets the visible text without HTML tags
			navigator.clipboard.writeText(text).then(() => {
				const originalText = els.copyBtn.textContent;
				els.copyBtn.textContent = translations[currentLang].copied;
				setTimeout(() => {
					els.copyBtn.textContent = translations[currentLang].copyText;
				}, 2000);
			});
		}

		function downloadLog() {
			const text = els.outputLog.innerText;
			const blob = new Blob([text], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'chatlog_processed.txt';
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}

		function openGoogleDocs() {
			window.open('https://docs.google.com/document/create', '_blank');
		}

		// Start
		init();

	</script>
</body>

</html>